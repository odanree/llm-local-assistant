# v2.6 File Structure - Visual Reference

## Quick Map: Where Does TTS Code Live?

```
YOUR MACHINE                          VS CODE EXTENSION BUNDLE
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   python/           â”‚              â”‚  llm-local-assistant/        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚              â”‚                              â”‚
â”‚ â”‚ tts_service.py  â”‚â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â†’ Main TTS logic (subprocess)
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚              â”‚                              â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚              â”‚  src/                        â”‚
â”‚ â”‚ setup_tts.py    â”‚â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â†’ Setup/download ChatTTS     â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚              â”‚                              â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚              â”‚  src/services/               â”‚
â”‚ â”‚ test_tts.py     â”‚â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â†’ Testing                    â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚              â”‚    ttsService.ts (bridge)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚                              â”‚
                                     â”‚  src/commands/               â”‚
                                     â”‚    explain.ts (modified)     â”‚
                                     â”‚                              â”‚
                                     â”‚  src/types/                  â”‚
                                     â”‚    tts.ts (interfaces)       â”‚
                                     â”‚                              â”‚
                                     â”‚  webview/                    â”‚
                                     â”‚    components/               â”‚
                                     â”‚      AudioPlayer.tsx         â”‚
                                     â”‚    panels/                   â”‚
                                     â”‚      ExplanationPanel.tsx    â”‚
                                     â”‚    styles/                   â”‚
                                     â”‚      audioPlayer.css         â”‚
                                     â”‚                              â”‚
                                     â”‚  docs/                       â”‚
                                     â”‚    VOICE_NARRATION.md        â”‚
                                     â”‚                              â”‚
                                     â”‚  package.json (settings)     â”‚
                                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Execution Flow: `/explain` with Voice

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User types     â”‚
â”‚  /explain foo.tsâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  extension.ts                  â”‚
  â”‚  handleExplainCommand()         â”‚
  â”‚  (Event handler)               â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”œâ”€ Generate explanation text
           â”‚
           â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  src/commands/explain.ts       â”‚
  â”‚  explainCommand()              â”‚
  â”‚                                â”‚
  â”‚  1. Get explanation            â”‚
  â”‚  2. Check settings (voice OK?) â”‚
  â”‚  3. Call ttsService.synthesize â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  src/services/ttsService.ts    â”‚
  â”‚  synthesize({text, lang})      â”‚
  â”‚                                â”‚
  â”‚  1. Split text at sentences    â”‚
  â”‚  2. Spawn Python subprocess    â”‚
  â”‚  3. Collect audio buffer       â”‚
  â”‚  4. Save to .llm-cache/audio/  â”‚
  â”‚  5. Return TTSResult           â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚                             â”‚
           â–¼                             â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ PYTHON PROCESS   â”‚      â”‚ Node.js waits for...   â”‚
  â”‚                  â”‚      â”‚                        â”‚
  â”‚ python/          â”‚      â”‚ - Stdout (audio buffer)â”‚
  â”‚ tts_service.py   â”‚      â”‚ - Stderr (metadata)    â”‚
  â”‚                  â”‚      â”‚ - Process close event  â”‚
  â”‚ 1. Load model    â”‚      â”‚                        â”‚
  â”‚ 2. Call infer()  â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚ 3. Convert WAV   â”‚
  â”‚ 4. Write stdout  â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Audio buffer returned         â”‚
  â”‚  - WAV data (24kHz)            â”‚
  â”‚  - Size info                   â”‚
  â”‚  - Duration calculated         â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  extension.ts                  â”‚
  â”‚  panel.webview.postMessage({   â”‚
  â”‚    command: 'showExplanation'  â”‚
  â”‚    text: explanation,          â”‚
  â”‚    audio: {                    â”‚
  â”‚      path: audioPath,          â”‚
  â”‚      sampleRate: 24000,        â”‚
  â”‚      duration: 5.2             â”‚
  â”‚    }                           â”‚
  â”‚  })                            â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  webview/                      â”‚
  â”‚  ExplanationPanel.tsx          â”‚
  â”‚  (receives message)            â”‚
  â”‚                                â”‚
  â”‚  â””â”€ AudioPlayer                â”‚
  â”‚     (Play/Pause/Speed)         â”‚
  â”‚  â””â”€ Explanation text           â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  User clicks Play              â”‚
  â”‚  HTML5 Audio API               â”‚
  â”‚  Plays file:///.llm-cache/...  â”‚
  â”‚                                â”‚
  â”‚  ğŸ”Š Narration plays            â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Directory Tree (High-level)

```
llm-local-assistant/
â”‚
â”œâ”€ python/                          â† NEW: TTS service
â”‚  â”œâ”€ tts_service.py               â† ChatTTS wrapper
â”‚  â”œâ”€ setup_tts.py                 â† Setup script
â”‚  â””â”€ test_tts.py                  â† Tests
â”‚
â”œâ”€ src/
â”‚  â”œâ”€ extension.ts                 â† MODIFIED: Register voice commands
â”‚  â”‚
â”‚  â”œâ”€ commands/                    â† NEW or MODIFIED
â”‚  â”‚  â”œâ”€ index.ts                  â† Command registry
â”‚  â”‚  â””â”€ explain.ts                â† MODIFIED: Add voice support
â”‚  â”‚
â”‚  â”œâ”€ services/                    â† MODIFIED
â”‚  â”‚  â”œâ”€ ttsService.ts             â† NEW: Node.js TTS bridge
â”‚  â”‚  â””â”€ index.ts                  â† MODIFIED: Export ttsService
â”‚  â”‚
â”‚  â”œâ”€ types/                       â† MODIFIED
â”‚  â”‚  â”œâ”€ tts.ts                    â† NEW: TTS interfaces
â”‚  â”‚  â””â”€ index.ts                  â† MODIFIED: Export tts types
â”‚  â”‚
â”‚  â””â”€ ... (existing files unchanged)
â”‚
â”œâ”€ webview/
â”‚  â”œâ”€ components/                  â† MODIFIED
â”‚  â”‚  â”œâ”€ AudioPlayer.tsx           â† NEW: Audio player widget
â”‚  â”‚  â””â”€ index.ts                  â† MODIFIED: Export AudioPlayer
â”‚  â”‚
â”‚  â”œâ”€ panels/                      â† MODIFIED
â”‚  â”‚  â”œâ”€ ExplanationPanel.tsx      â† MODIFIED: Add AudioPlayer
â”‚  â”‚  â””â”€ ... (other panels)
â”‚  â”‚
â”‚  â”œâ”€ styles/                      â† MODIFIED
â”‚  â”‚  â”œâ”€ audioPlayer.css           â† NEW: Audio player styles
â”‚  â”‚  â””â”€ index.css                 â† MODIFIED: Import audioPlayer.css
â”‚  â”‚
â”‚  â””â”€ index.html, index.ts         â† Existing webview files
â”‚
â”œâ”€ docs/                            â† MODIFIED
â”‚  â”œâ”€ VOICE_NARRATION.md           â† NEW: Setup & usage guide
â”‚  â””â”€ ... (existing docs)
â”‚
â”œâ”€ .llm-cache/                     â† NEW: Runtime cache (gitignored)
â”‚  â””â”€ audio/                       â† Audio files cache
â”‚      â”œâ”€ explain-*.wav
â”‚      â””â”€ ...
â”‚
â”œâ”€ V2.6_VOICE_NARRATION_PLAN.md   â† Implementation plan
â”œâ”€ V2.6_FILE_STRUCTURE.md          â† This file
â”œâ”€ package.json                    â† MODIFIED: Settings + commands
â”œâ”€ .gitignore                      â† MODIFIED: Add .llm-cache/
â””â”€ ... (other config files unchanged)
```

## File Count by Type

```
NEW FILES:
  Python:     3 files  (python/*.py)
  TypeScript: 4 files  (services, commands, types)
  React:      2 files  (components, panels)
  CSS:        1 file   (styles)
  Docs:       1 file   (docs)
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Total:      11 files

MODIFIED FILES:
  extension.ts       â† Register voice commands
  src/services/index.ts      â† Export ttsService
  src/types/index.ts         â† Export tts types
  src/commands/index.ts      â† Register explain command
  webview/components/index.ts â† Export AudioPlayer
  webview/panels/index.ts     â† Export ExplanationPanel
  webview/styles/index.css   â† Import audioPlayer.css
  package.json       â† Add voice settings & commands
  .gitignore        â† Add .llm-cache/
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Total:      9 files (mostly minor changes)

UNCHANGED:
  Everything else (tsconfig, webpack, vitest, etc.)
```

## Layer Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              USER INTERFACE (Webview)               â”‚
â”‚                                                      â”‚
â”‚  ExplanationPanel.tsx                               â”‚
â”‚  â”œâ”€ AudioPlayer.tsx (Play/Pause/Speed/Volume)      â”‚
â”‚  â””â”€ Explanation text                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ postMessage
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           EXTENSION (VS Code API Layer)             â”‚
â”‚                                                      â”‚
â”‚  extension.ts                                       â”‚
â”‚  â”œâ”€ Command handlers                               â”‚
â”‚  â”œâ”€ Webview message routing                        â”‚
â”‚  â””â”€ Settings management                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            BUSINESS LOGIC (Services)                â”‚
â”‚                                                      â”‚
â”‚  src/services/ttsService.ts                        â”‚
â”‚  â”œâ”€ Spawns Python subprocess                       â”‚
â”‚  â”œâ”€ Handles audio buffer                           â”‚
â”‚  â”œâ”€ Text chunking                                  â”‚
â”‚  â””â”€ Error handling                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ spawn subprocess
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           PYTHON RUNTIME (Separate Process)         â”‚
â”‚                                                      â”‚
â”‚  python/tts_service.py                            â”‚
â”‚  â”œâ”€ Load ChatTTS model (GPU optional)              â”‚
â”‚  â”œâ”€ Text synthesis                                 â”‚
â”‚  â”œâ”€ WAV conversion                                 â”‚
â”‚  â””â”€ Stdout output                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Key Separation: Node.js vs Python

```
NODE.JS (TypeScript/JavaScript)    |  PYTHON
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  |  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Runs inside VS Code                |  Runs as subprocess
Fast, event-driven                 |  Sync, blocking calls
Handles UI/events                  |  Handles TTS logic
Bundles with extension             |  User installs separately
~200KB added                        |  ~1GB model download
Subprocess manager                 |  Model execution
No ML libraries                    |  PyTorch, ChatTTS

WHY SPLIT?
âœ“ Python dependencies don't conflict with Node.js
âœ“ Large ML models not bundled with extension
âœ“ Can swap TTS models without rebuilding extension
âœ“ Users can manage their own Python environment
âœ“ Easier to update TTS without updating extension
```

## Build & Runtime Flow

```
DEVELOPMENT:
npm install          â†’ Install Node.js deps
npm run compile      â†’ Compile TypeScript (src/)
npm test             â†’ Run tests (*.test.ts)

For Python:
python python/setup_tts.py  â†’ Download ChatTTS model
python python/test_tts.py   â†’ Test synthesis

BUILD:
npm run vscode:prepublish   â†’ Webpack bundle (dist/extension.js)
vsce publish                â†’ Package for VS Code Marketplace

RUNTIME (User):
1. Install extension (VS Code)
2. Run /setup-voice          (Downloads ChatTTS)
3. Use /explain              (Calls Python subprocess)
```

## Testing Strategy

```
Unit Tests (npm test):
  âœ“ ttsService.synthesize()
  âœ“ Text splitting logic
  âœ“ Device detection
  âœ“ AudioPlayer props

Integration Tests:
  âœ“ /setup-voice command
  âœ“ /test-voice command
  âœ“ /explain with audio

Manual Tests:
  âœ“ /explain (short text)
  âœ“ /explain (long text, auto-chunking)
  âœ“ Audio player controls
  âœ“ Settings persistence
  âœ“ Cross-platform (Mac/Win/Linux)
```

## Summary

**New v2.6 code lives in 4 places:**

1. **`python/`** - ChatTTS model service (separate process)
2. **`src/services/`** - Node.js bridge to Python
3. **`webview/`** - React audio player UI
4. **`docs/`** - User documentation

**Only modifies 2 core files:**
- `extension.ts` - Register voice commands
- `package.json` - Settings + commands

**Everything else stays untouched.** Clean, modular, easy to maintain.
